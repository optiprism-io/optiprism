name: UI Build and Deploy

env:
  PROJECT_ID: optiprism
  SERVICE: ui
  DEV_HOST: dev.optiprism.io

on:
  workflow_dispatch:
    inputs:
      seat:
        description: 'Seat on cluster'
        required: true
        type: choice
        options:
          - nikolai-kushner
          - evgeniy-kozlov

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Extract branch name
        shell: bash
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        id: extract_branch

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v0
        with:
          credentials_json: ${{ secrets.GCR_JSON_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Authorize Docker
        run: gcloud auth configure-docker

      - name: Build and Push Container
        run: |-
          docker build -f docker/ui.Dockerfile -t eu.gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE }}:${{ steps.extract_branch.outputs.branch }} .
          docker push eu.gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE }}:${{ steps.extract_branch.outputs.branch }}

      - uses: danielr1996/envsubst-action@1.0.0
        env:
          IMAGE_REPO: eu.gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE }}
          IMAGE_TAG: ${{ steps.extract_branch.outputs.branch }}
          SEAT: ${{ github.event.inputs.seat }}
        with:
          input: cloud/kubernetes/ui/deployment.tpl.yaml
          output: cloud/kubernetes/ui/deployment.yaml

      - uses: actions-hub/kubectl@master
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        with:
          args: apply -f cloud/kubernetes/ui/deployment.yaml